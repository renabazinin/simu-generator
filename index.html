<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Gemini Simulation Generator (Frontend Demo)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { color-scheme: light dark; --bg:#0c1015; --panel:#141a21; --panel-border:#202a33; --text:#e6ebf0; --text-dim:#8b97a3; --accent:#2563eb; --accent-hover:#1d4ed8; --danger:#dc2626; --mono: ui-monospace, SFMono-Regular, Consolas, "Courier New", monospace; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, Arial, sans-serif; background: var(--bg); color: var(--text); width:100%; }
    h1 { display:none; }
    .topbar { width:100%; display:flex; align-items:center; gap:1.5rem; padding:.85rem 1.4rem; background:#10161c; border-bottom:1px solid #1e272f; position:sticky; top:0; z-index:40; }
    .brand { font-weight:600; letter-spacing:.7px; font-size:1.05rem; display:flex; align-items:center; gap:.5rem; }
    .brand span.chip { background:#334155; padding:.25rem .55rem; border-radius:999px; font-size:.55rem; letter-spacing:.5px; }
    .subject-wrap { flex:1; display:flex; flex-direction:column; }
    .subject-wrap label { font-size:.55rem; letter-spacing:.15rem; text-transform:uppercase; color:var(--text-dim); font-weight:600; margin-bottom:.25rem; }
    #subject { font:inherit; font-weight:600; font-size:1.5rem; padding:.65rem 1rem; border-radius:12px; background:#182129; border:1px solid #27323c; color:var(--text); outline:none; width:100%; transition:.18s border,.18s background; }
    #subject:focus { border-color:var(--accent); background:#161e26; }
    #subject::placeholder { color:#556371; font-weight:500; }
    .actions { display:flex; flex-wrap:wrap; gap:.55rem; }
    .actions button { cursor:pointer; font:inherit; font-weight:600; border:1px solid #2a3742; background:#212b34; color:#e2e8ec; padding:.55rem .85rem; border-radius:9px; letter-spacing:.4px; display:inline-flex; align-items:center; gap:.4rem; transition:.15s background,.15s border; }
    .actions button.primary { background:var(--accent); color:#fff; }
    .actions button.primary:hover:not(:disabled){ background:var(--accent-hover); }
    .actions button:hover:not(.primary):not(:disabled){ background:#29343e; }
    .actions button:disabled { opacity:.45; cursor:not-allowed; }
    .warn-box { font-size:.62rem; line-height:1.2rem; background:#332504; color:#f7d088; border:1px solid #8a5d14; padding:.55rem .75rem; border-radius:9px; margin:.55rem 1.4rem 0; }
    .main { width:100%; padding:1.1rem 1.4rem 2.4rem; display:grid; gap:1.1rem; grid-template-columns: minmax(300px,360px) 1fr 400px; }
    @media (max-width:1450px){ .main { grid-template-columns: minmax(300px,360px) 1fr; } .logs-panel { grid-column:1 / -1; order:3; } }
    @media (max-width:980px){ .main { grid-template-columns:1fr; } }
    .panel { background:var(--panel); border:1px solid var(--panel-border); border-radius:18px; padding:1rem 1.1rem 1.25rem; display:flex; flex-direction:column; gap:.9rem; min-height:0; }
    .panel h2 { margin:.1rem 0 .2rem; font-size:.78rem; font-weight:600; letter-spacing:.55rem; display:flex; align-items:center; gap:.45rem; color:var(--text-dim); text-transform:uppercase; }
    label { font-size:.58rem; text-transform:uppercase; letter-spacing:.15rem; font-weight:600; opacity:.75; display:flex; flex-direction:column; gap:.4rem; }
    input[type=password], select, textarea { background:#111921; color:var(--text); border:1px solid #26323c; border-radius:9px; padding:.6rem .6rem; font:inherit; outline:none; transition:.16s border,.16s background; }
    input[type=password]:focus, select:focus, textarea:focus { border-color:var(--accent); background:#10171e; }
    select { cursor:pointer; }
    textarea { resize:vertical; min-height:150px; line-height:1.4; font-size:.82rem; }
    .metrics { display:flex; flex-wrap:wrap; gap:.5rem; font-size:.58rem; letter-spacing:.05rem; }
    .metric { background:#10171e; border:1px solid #22303b; padding:.38rem .55rem; border-radius:7px; }
    #status { font-family:var(--mono); background:#10171d; border:1px solid #22303b; padding:.75rem .85rem; border-radius:13px; font-size:.64rem; line-height:1.1rem; overflow:auto; flex:1; min-height:200px; max-height:420px; }
    #status .line { white-space:pre-wrap; word-break:break-word; }
    #status .success { color:#16a34a; }
    #status .error { color:#f87171; }
    #status .info { color:#60a5fa; }
    #status .warn { color:#fbbf24; }
    #preview-wrapper { display:flex; flex-direction:column; gap:.75rem; }
    #preview { width:100%; aspect-ratio:9/16; border:1px solid #22303b; border-radius:18px; background:#0a0f13; }
    .raw-block { background:#0f161d; border:1px solid #22303b; border-radius:14px; padding:.75rem .85rem; font-family:var(--mono); font-size:.6rem; line-height:1.05rem; max-height:360px; overflow:auto; }
    .toggle-link { font-size:.58rem; text-transform:uppercase; letter-spacing:.15rem; color:#60a5fa; cursor:pointer; user-select:none; font-weight:600; }
    .footer { text-align:center; font-size:.55rem; opacity:.5; padding:1rem 0 2.4rem; letter-spacing:.12rem; }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">Gemini Simulation <span class="chip">Demo</span></div>
    <div class="subject-wrap">
      <label for="subject">Subject</label>
      <input id="subject" type="text" placeholder="Enter Subject (e.g. Bubble Sort, Semaphore, Graph BFS)" autocomplete="off" />
    </div>
    <div class="actions">
      <button id="toggleKeyBtn" title="Show/Hide API Key">Show Key</button>
      <button id="showRawBtn" disabled>Show Raw</button>
      <button id="clearBtn" title="Clear logs">Clear</button>
      <button id="generateBtn" class="primary">Generate</button>
      <button id="downloadBtn" disabled>Download</button>
      <button id="copyBtn" disabled>Copy</button>
    </div>
  </div>
  <p class="warn-box">Frontend-only demo: API key is only held in memory. For production use a secure backend proxy.</p>
  <div class="main">
    <div class="panel config-panel">
      <h2>CONFIG</h2>
      <label>API Key
        <input id="apiKey" type="password" placeholder="Paste GEMINI_API_KEY here" autocomplete="off" />
      </label>
      <label>Model
        <select id="model">
          <option value="gemini-3-pro">gemini-3-pro (Gemini 3 Pro)</option>
          <option value="gemini-2.5-pro" selected>gemini-2.5-pro (Gemini 2.5 Pro)</option>
          <option value="gemini-2.5-flash">gemini-2.5-flash (Gemini 2.5 Flash)</option>
          <option value="gemini-2.5-flash-lite">gemini-2.5-flash-lite (Gemini 2.5 Flash-Lite)</option>
          <option value="gemini-2.0-flash">gemini-2.0-flash (Gemini 2.0 Flash)</option>
          <option value="gemini-2.0-flash-lite">gemini-2.0-flash-lite (Gemini 2.0 Flash-Lite)</option>
          <option value="gemini-1.5-flash">gemini-1.5-flash (legacy fallback)</option>
        </select>
      </label>
      <label>Extra Prompt
        <textarea id="extraPrompt" placeholder="Additional instructions (optional)"></textarea>
      </label>
      <div class="metrics" id="metrics"></div>
    </div>
    <div class="panel preview-panel">
      <h2>PREVIEW</h2>
      <div id="preview-wrapper">
        <iframe id="preview"></iframe>
      </div>
      <div class="flex-col" id="rawContainer" hidden>
        <span class="toggle-link" id="collapseRaw">Hide Raw Output</span>
        <div class="raw-block" id="rawOutput"></div>
      </div>
    </div>
    <div class="panel logs-panel">
      <h2>LOGS</h2>
      <div id="status" aria-live="polite"></div>
    </div>
  </div>
  <div class="footer">Gemini Frontend Demo · Educational Use Only</div>

  <script>
    const statusEl = document.getElementById('status');
    const apiKeyEl = document.getElementById('apiKey');
    const subjectEl = document.getElementById('subject');
    const modelEl = document.getElementById('model');
    const extraPromptEl = document.getElementById('extraPrompt');
    const generateBtn = document.getElementById('generateBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const copyBtn = document.getElementById('copyBtn');
  const showRawBtn = document.getElementById('showRawBtn');
  const clearBtn = document.getElementById('clearBtn');
  const toggleKeyBtn = document.getElementById('toggleKeyBtn');
    const previewWrapper = document.getElementById('preview-wrapper');
    const previewFrame = document.getElementById('preview');
  const rawContainer = document.getElementById('rawContainer');
  const rawOutput = document.getElementById('rawOutput');
  const collapseRaw = document.getElementById('collapseRaw');
  const metricsEl = document.getElementById('metrics');

    let lastHTML = '';
    let lastRaw = '';

  const masterPrompt = `
You are an expert web developer specializing in creating educational, animated simulations with vanilla HTML, CSS, and JavaScript.

Your task is to generate a single, self-contained \`index.html\` file that visually simulates the computer science concept of: **{{SUBJECT}}**.

Follow these requirements strictly:

1. **Single File Output:** All HTML, CSS, and JavaScript must be contained within a single \`index.html\` file. CSS inside \`<style>\` in \`<head>\`; JavaScript inside one \`<script>\` tag at end of \`<body>\`.
2. **No External Libraries:** Only vanilla JS (ES6+). No frameworks.
3. **Visual Style & Layout:**
  * Clean, minimalist, polished design; consistent spacing & alignment.
  * Vertical 1080x1920 feel; center in viewport; responsive scaling if needed.
  * SVG for all animated elements; avoid pixel jitter (use whole coords or smooth interpolation).
  * Abstract concepts mapped to iconic shapes (circles, rectangles, arrows, tokens).
  * Accessible contrast; cohesive palette; no harsh flicker.
4. **Step Narration:**
  * Display a step label that updates: e.g. "Step 1: Initialize", "Step 2: Sorting a[n-1]".
  * Each step has short explanatory text; stable on screen ≥ ~2 seconds for readability.
  * Steps form a logical cycle then loop smoothly.
5. **Animation & Pacing:**
  * Single \`requestAnimationFrame\` loop controlling timing.
  * Total loop ≈ 20–30 seconds; no rapid unreadable flashes.
  * Smooth eased transitions; no abrupt jumps, overlapping text, or layout shifts.
6. **Code Quality / Structure:**
  * Separate: init/setup, state, update(dt), render(), step/phase management.
  * Use delta time for consistent motion across frame rates.
  * Functions: \`init()\`, \`advanceStep()\`, \`update(dt)\`, \`render()\` (or equivalents).
  * Concise comments for non-trivial logic & step changes.
7. **Loop Behavior:**
  * Graceful reset at end step; no visual flash.
  * Only minimal state fields reset.
8. **Analogy:**
  * Choose a simple analogy (e.g., parking lot for semaphore) and reflect it visually + in step narration.

Generate the complete valid \`index.html\` implementing all of the above.
  `;

    function log(msg, cls) {
      const line = document.createElement('div');
      if (cls) line.className = cls;
      line.textContent = msg;
      statusEl.appendChild(line);
      statusEl.scrollTop = statusEl.scrollHeight;
    }

    function buildPrompt() {
      const subject = subjectEl.value.trim() || 'Semaphore';
      const base = masterPrompt.replace('{{SUBJECT}}', subject);
      const extra = extraPromptEl.value.trim();
      return extra ? base + '\n\nExtra Instructions:\n' + extra : base;
    }

    async function generate() {
      const key = apiKeyEl.value.trim();
      if (!key) { alert('Enter API Key'); return; }
      const subject = subjectEl.value.trim() || 'Semaphore';
      const originalModel = modelEl.value.trim();
      const prompt = buildPrompt();
      lastHTML = '';
      lastRaw = '';
      previewWrapper.hidden = true;
  rawContainer.hidden = true;
      downloadBtn.disabled = true;
      copyBtn.disabled = true;
  showRawBtn.disabled = true;
      statusEl.innerHTML = '';
      log(`Subject: ${subject}`);
      log(`Requested Model: ${originalModel}`);
      log(`Prompt chars: ${prompt.length}`);
      generateBtn.disabled = true;
      generateBtn.textContent = 'Generating…';

      try {
        const {finalModel, html} = await generateWithFallback({
          key,
          prompt,
          subject,
          requestedModel: originalModel
        });
        lastHTML = html;
        showHTML(html);
        downloadBtn.disabled = false;
        copyBtn.disabled = false;
        showRawBtn.disabled = false;
        log(`✅ Generation complete with model: ${finalModel}`, 'success');
      } catch (err) {
        log('❌ Error: ' + (err.message || err), 'error');
      } finally {
        generateBtn.disabled = false;
        generateBtn.textContent = 'Generate Simulation';
      }
    }

    const MODEL_ALIASES = {
      // Map older or ambiguous names to current model identifiers
      'gemini-pro':'gemini-2.5-pro',
      'gemini-pro-latest':'gemini-2.5-pro',
      'gemini-2.5-pro-latest':'gemini-2.5-pro',
      'gemini-1.5-pro-latest':'gemini-2.5-pro'
    };
    const KNOWN_MODELS = new Set([
      'gemini-3-pro',
      'gemini-2.5-pro',
      'gemini-2.5-flash',
      'gemini-2.5-flash-lite',
      'gemini-2.0-flash',
      'gemini-2.0-flash-lite',
      'gemini-1.5-flash'
    ]);
    // Preferred fallback order (most capable / preferred first)
    const FALLBACK_CHAIN = [
      'gemini-3-pro',
      'gemini-2.5-pro',
      'gemini-2.5-flash',
      'gemini-2.5-flash-lite',
      'gemini-2.0-flash',
      'gemini-2.0-flash-lite',
      'gemini-1.5-flash'
    ];

    function normalizeModel(m) {
      if (MODEL_ALIASES[m]) {
        log(`Alias: mapping ${m} -> ${MODEL_ALIASES[m]}`,'info');
        return MODEL_ALIASES[m];
      }
      return m;
    }

    async function generateWithFallback({key, prompt, subject, requestedModel}) {
      const tried = [];
      const norm = normalizeModel(requestedModel);
      let chain = [norm, ...FALLBACK_CHAIN.filter(m=>m!==norm)];
      chain = chain.filter((m,i)=>chain.indexOf(m)===i); // dedupe
      for (let i=0;i<chain.length;i++) {
        const model = chain[i];
        log(`Attempt ${i+1}/${chain.length} using model: ${model}`);
        if (!KNOWN_MODELS.has(model)) {
          log(`Model ${model} not in KNOWN_MODELS set, skipping.`,'warn');
          continue;
        }
        try {
          const result = await callModel({key, model, prompt, subject});
          return { finalModel: model, html: result };
        } catch (e) {
          tried.push({model, error: e});
          const code = e.__httpStatus || 0;
            if (code === 500 || code === 404 || code === 503) {
              log(`Server/availability error (${code}) on ${model}; trying next fallback…`,'warn');
              continue;
            }
            log(`Non-retryable error on ${model}: ${e.message}`,'error');
            break;
        }
      }
      throw new Error(`All models failed. Tried: ${tried.map(t=>t.model).join(', ')}`);
    }

    async function callModel({key, model, prompt, subject}) {
      const body = { contents: [ { parts: [ { text: prompt } ] } ] };
      const url = `https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent(model)}:generateContent?key=${encodeURIComponent(key)}`;
      const t0 = performance.now();
      log('Calling Gemini REST endpoint…');
      const resp = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
      const json = await resp.json().catch(()=>({}));
      const t1 = performance.now();
      const elapsed = (t1 - t0).toFixed(0);
      log(`HTTP ${resp.status} in ${elapsed} ms`);
      metricsEl.innerHTML = `<span class="metric">Status: ${resp.status}</span><span class="metric">Time: ${elapsed}ms</span><span class="metric">Prompt: ${prompt.length} chars</span><span class="metric">Model: ${model}</span>`;
      if (!resp.ok) {
        log(JSON.stringify(json, null, 2), 'error');
        const err = new Error('Request failed');
        err.__httpStatus = resp.status;
        throw err;
      }
      let text = extractText(json);
      lastRaw = text;
      log(`Raw length: ${text.length}`);
      log(`Snippet: ${text.replace(/\s+/g,' ').slice(0,100)}${text.length>100?'…':''}`);
      let html = text.trim();
      if (/^```/i.test(html)) {
        log('Detected fenced code block — stripping.');
        html = html.replace(/^```html?/i,'').replace(/```$/,'').trim();
      }
      if (!/<!DOCTYPE html>/i.test(html)) {
        log('No <!DOCTYPE html> found — wrapping content.');
        html = `<!DOCTYPE html>\n<html><head><meta charset=\"UTF-8\"><title>${subject}</title></head><body>` + html + '</body></html>';
      }
      return html;
    }

    function extractText(resp) {
      // Gemini REST returns candidates[].content.parts[].text
      if (!resp || !resp.candidates) return '';
      const parts = [];
      for (const c of resp.candidates) {
        if (c.content && Array.isArray(c.content.parts)) {
          for (const p of c.content.parts) {
            if (p.text) parts.push(p.text); else if (p.inlineData) parts.push('[binary data omitted]');
          }
        }
      }
      return parts.join('\n');
    }

    function showHTML(html) {
      const blob = new Blob([html], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      previewWrapper.hidden = false;
      previewFrame.src = url;
      rawOutput.textContent = lastRaw;
    }

    generateBtn.addEventListener('click', generate);
    copyBtn.addEventListener('click', () => {
      if (!lastHTML) return;
      navigator.clipboard.writeText(lastHTML).then(()=>log('Copied HTML to clipboard.','success'));
    });
    downloadBtn.addEventListener('click', () => {
      if (!lastHTML) return;
      const subject = subjectEl.value.trim() || 'simulation';
      const a = document.createElement('a');
      a.download = `${subject.toLowerCase().replace(/\s+/g,'-')}-simulation.html`;
      a.href = URL.createObjectURL(new Blob([lastHTML], { type: 'text/html' }));
      a.click();
      log('Download started.');
    });
    showRawBtn.addEventListener('click', () => {
      rawContainer.hidden = !rawContainer.hidden;
      showRawBtn.textContent = rawContainer.hidden ? 'Show Raw' : 'Hide Raw';
    });
    collapseRaw.addEventListener('click', () => { rawContainer.hidden = true; showRawBtn.textContent='Show Raw'; });
    clearBtn.addEventListener('click', () => { statusEl.innerHTML=''; metricsEl.innerHTML=''; log('Logs cleared','info'); });
    toggleKeyBtn.addEventListener('click', () => {
      apiKeyEl.type = apiKeyEl.type === 'password' ? 'text' : 'password';
      toggleKeyBtn.textContent = apiKeyEl.type === 'password' ? 'Show Key' : 'Hide Key';
    });

    // Allow Enter key in subject to trigger generate
    subjectEl.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); generateBtn.click(); } });
  </script>
</body>
</html>
